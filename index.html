<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sortition Algorithm Comparison</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            padding: 40px 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2em;
            margin-bottom: 30px;
            color: #2c3e50;
            font-weight: 600;
        }

        .controls {
            margin-bottom: 40px;
        }

        .controls label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #34495e;
        }

        .controls select {
            width: 100%;
            max-width: 500px;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .controls select:hover {
            border-color: #3498db;
        }

        .controls select:focus {
            outline: none;
            border-color: #2980b9;
        }

        .comparison-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .algorithm-section {
            background: #fafbfc;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e1e8ed;
        }

        .algorithm-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e8ed;
            color: #2c3e50;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 25px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 4px;
        }

        th, td {
            padding: 8px 10px;
            text-align: center;
            font-size: 12px;
        }

        th {
            background: #34495e;
            color: white;
            font-weight: 600;
            border-radius: 4px;
        }

        th.corner {
            background: #2c3e50;
            font-size: 11px;
            font-style: italic;
            color: rgba(255,255,255,0.8);
        }

        th.header-cell {
            font-size: 12px;
            min-width: 70px;
        }

        td.row-header {
            background: #34495e;
            color: white;
            font-weight: 600;
            text-align: left;
            padding-left: 12px;
            border-radius: 4px;
            min-width: 120px;
            max-width: 150px;
        }

        td.data-cell {
            background: white;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            transition: transform 0.2s;
            position: relative;
            min-width: 50px;
            max-width: 70px;
        }

        td.data-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        td.margin-cell {
            background: #ecf0f1;
            font-weight: 600;
            font-size: 13px;
            border-radius: 4px;
            min-width: 60px;
        }

        .quota-info {
            display: block;
            font-size: 10px;
            color: #95a5a6;
            margin-top: 2px;
            font-weight: normal;
        }

        .stats-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
        }

        .stats-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-item.gini .stat-value {
            color: #3498db;
        }

        .stat-item.empty .stat-value {
            color: #e74c3c;
        }

        .stat-item.sparse .stat-value {
            color: #f39c12;
        }

        .stat-item.good .stat-value {
            color: #27ae60;
        }

        .comment-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-left: 3px solid #bdc3c7;
            border-radius: 6px;
            display: none;
        }

        .comment-section.active {
            display: block;
        }

        .comment-section p {
            color: #5d6d7e;
            line-height: 1.6;
            font-size: 14px;
        }

        .legend {
            margin-top: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .legend-items {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 40px;
            height: 25px;
            border-radius: 4px;
        }

        @media (max-width: 1200px) {
            .comparison-wrapper {
                grid-template-columns: 1fr;
            }

            th.header-cell {
                min-width: 60px;
            }

            td.row-header {
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sortition Algorithm Comparison: Leximin vs Diversimax</h1>

        <div class="controls">
            <label for="datasetSelect">Select Intersection:</label>
            <select id="datasetSelect"></select>
        </div>

        <div class="comparison-wrapper">
            <div class="algorithm-section leximin-section">
                <h2 class="algorithm-title">Leximin</h2>
                <div class="table-container" id="leximinTable"></div>
                <div class="stats-section">
                    <div class="stats-title">Statistics</div>
                    <div class="stats-grid" id="leximinStats"></div>
                </div>
            </div>

            <div class="algorithm-section diversimax-section">
                <h2 class="algorithm-title">Diversimax</h2>
                <div class="table-container" id="diversimaxTable"></div>
                <div class="stats-section">
                    <div class="stats-title">Statistics</div>
                    <div class="stats-grid" id="diversimaxStats"></div>
                </div>
            </div>
        </div>

        <div class="comment-section" id="commentSection">
            <p id="commentText"></p>
        </div>

        <div class="legend">
            <div class="legend-title">Color Scale</div>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc3545;"></div>
                    <span>0 (No Representation)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffd7a3;"></div>
                    <span>1-2 (Sparse)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fff9c4;"></div>
                    <span>3-5</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #c8e6c9;"></div>
                    <span>6-9</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #81c784;"></div>
                    <span>10+ (Well Represented)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const datasets = [
            {
                name: "Neighborhood × Gender - Raanana",
                gini: { leximin: 0.1, diversimax: 0 },
                distribution: {
                    rows: ["South", "North East", "North West"],
                    cols: ["Female", "Male"],
                    rows_name: "neighborhood",
                    cols_name: "gender",
                    leximin: [[14, 8], [9, 9], [9, 11]],
                    diversimax: [[10, 10], [10, 10], [10, 10]]
                },
                neighborhood_quotas: {
                    rows: ["North East", "North West", "South"],
                    quotas: [[18, 22], [15, 22], [19, 22]]
                },
                gender_quotas: {
                    rows: ["Male", "Female"],
                    quotas: [[26, 33], [26, 33]]
                }
            },
            {
                name: "Neighborhood × Religiousness - Raanana",
                gini: { leximin: 0.41, diversimax: 0.27 },
                distribution: {
                    rows: ["South", "North East", "North West"],
                    cols: ["Religious", "Secular", "Traditional"],
                    rows_name: "neighborhood",
                    cols_name: "religiousness",
                    leximin: [[5, 16, 1], [6, 10, 2], [2, 13, 5]],
                    diversimax: [[5, 10, 5], [5, 12, 3], [3, 12, 5]]
                },
                religiousness_quotas: {
                    rows: ["Secular", "Traditional", "Religious"],
                    quotas: [[34, 41], [8, 13], [8, 13]]
                },
                neighborhood_quotas: {
                    rows: ["North East", "North West", "South"],
                    quotas: [[18, 22], [15, 22], [19, 22]]
                }
            },
            {
                name: "Education × Gender - Raanana",
                gini: { leximin: 0.39, diversimax: 0.26 },
                distribution: {
                    rows: ["High School Diploma", "BA", "MA+", "Non-Academic Diploma"],
                    cols: ["Female", "Male"],
                    rows_name: "education",
                    cols_name: "gender",
                    leximin: [[0, 3], [15, 10], [14, 10], [3, 5]],
                    diversimax: [[4, 5], [14, 10], [9, 10], [3, 5]]
                },
                gender_quotas: {
                    rows: ["Male", "Female"],
                    quotas: [[26, 33], [26, 33]]
                },
                education_quotas: {
                    rows: ["Non-Academic Diploma", "MA+", "BA", "High School Diploma"],
                    quotas: [[1, 8], [12, 24], [17, 27], [3, 9]]
                }
            },
            {
                name: "Age × Gender - Kfar Saba",
                gini: { leximin: 0.35, diversimax: 0.11 },
                distribution: {
                    rows: ["22-29", "30-39", "40-49", "50-59", "60-69", "70+"],
                    cols: ["Female", "Male"],
                    rows_name: "age",
                    cols_name: "gender",
                    leximin: [[1, 2], [7, 0], [8, 7], [2, 5], [5, 7], [11, 5]],
                    diversimax: [[4, 3], [4, 4], [6, 5], [5, 6], [6, 6], [5, 6]]
                },
                age_quotas: {
                    rows: ["22-29", "30-39", "40-49", "50-59", "60-69", "70+"],
                    quotas: [[3, 8], [7, 14], [10, 15], [7, 13], [6, 12], [11, 16]]
                },
                gender_quotas: {
                    rows: ["Male", "Female"],
                    quotas: [[26, 34], [26, 34]]
                }
            },
            {
                name: "Religiousness × Gender - Kfar Saba",
                gini: { leximin: 0.43, diversimax: 0.33 },
                distribution: {
                    rows: ["Religious", "Secular", "Traditional"],
                    cols: ["Female", "Male"],
                    rows_name: "religiousness",
                    cols_name: "gender",
                    leximin: [[2, 1], [26, 18], [6, 7]],
                    diversimax: [[4, 4], [18, 19], [8, 7]]
                },
                gender_quotas: {
                    rows: ["Male", "Female"],
                    quotas: [[26, 34], [26, 34]]
                },
                religiousness_quotas: {
                    rows: ["Secular", "Traditional", "Religious"],
                    quotas: [[36, 44], [10, 16], [3, 8]]
                }
            },
            {
                name: "Education - Kfar Saba",
                gini: { leximin: 0.04, diversimax: 0.1 },
                distribution: {
                    rows: ["12-9", "15-13", "16+"],
                    cols: ["Count"],
                    rows_name: "education",
                    cols_name: "count",
                    leximin: [[18], [22], [20]],
                    diversimax: [[15], [21], [24]]
                },
                education_quotas: {
                    rows: ["12-9", "15-13", "16+"],
                    quotas: [[15, 30], [14, 24], [14, 24]]
                }
            }
        ];

        function getCellColor(value) {
            if (value === 0) return '#dc3545';
            if (value <= 2) return '#ffd7a3';
            if (value <= 5) return '#fff9c4';
            if (value <= 9) return '#c8e6c9';
            return '#81c784';
        }

        function getQuotaForRow(dataset, rowName) {
            const rowsName = dataset.distribution.rows_name;
            const quotasKey = rowsName + '_quotas';

            if (dataset[quotasKey]) {
                const idx = dataset[quotasKey].rows.indexOf(rowName);
                if (idx !== -1) {
                    return dataset[quotasKey].quotas[idx];
                }
            }
            return null;
        }

        function getQuotaForCol(dataset, colName) {
            const colsName = dataset.distribution.cols_name;
            const quotasKey = colsName + '_quotas';

            if (dataset[quotasKey]) {
                const idx = dataset[quotasKey].rows.indexOf(colName);
                if (idx !== -1) {
                    return dataset[quotasKey].quotas[idx];
                }
            }
            return null;
        }

        function calculateStats(data) {
            const flat = data.flat();
            const empty = flat.filter(x => x === 0).length;
            const sparse = flat.filter(x => x >= 1 && x <= 2).length;
            const good = flat.filter(x => x >= 3).length;

            return { empty, sparse, good };
        }

        function renderTable(containerId, data, dataset, algorithm) {
            const container = document.getElementById(containerId);
            const dist = dataset.distribution;
            const matrix = dist[algorithm];

            // Capitalize first letter for display
            const rowsLabel = dist.rows_name.charAt(0).toUpperCase() + dist.rows_name.slice(1);
            const colsLabel = dist.cols_name.charAt(0).toUpperCase() + dist.cols_name.slice(1);

            let html = '<table><thead><tr>';
            html += `<th class="corner">${rowsLabel} ↓<br>${colsLabel} →</th>`;

            dist.cols.forEach(col => {
                html += `<th class="header-cell">${col}</th>`;
            });
            html += `<th class="header-cell">Total<br><span class="quota-info">quota</span></th>`;
            html += '</tr></thead><tbody>';

            dist.rows.forEach((row, i) => {
                html += '<tr>';
                html += `<td class="row-header">${row}</td>`;

                dist.cols.forEach((col, j) => {
                    const value = matrix[i][j];
                    const color = getCellColor(value);
                    html += `<td class="data-cell" style="background: ${color}; color: ${value === 0 ? 'white' : 'inherit'};">${value}</td>`;
                });

                const rowSum = matrix[i].reduce((a, b) => a + b, 0);
                const quota = getQuotaForRow(dataset, row);
                const quotaText = quota ? `<span class="quota-info">${quota[0]}-${quota[1]}</span>` : '';
                html += `<td class="margin-cell">${rowSum}<br>${quotaText}</td>`;
                html += '</tr>';
            });

            html += '<tr>';
            html += `<td class="row-header">Total<br><span class="quota-info" style="color: rgba(255,255,255,0.7);">quota</span></td>`;

            dist.cols.forEach((col, j) => {
                const colSum = matrix.reduce((sum, row) => sum + row[j], 0);
                const quota = getQuotaForCol(dataset, col);
                const quotaText = quota ? `<span class="quota-info">${quota[0]}-${quota[1]}</span>` : '';
                html += `<td class="margin-cell">${colSum}<br>${quotaText}</td>`;
            });

            const total = matrix.flat().reduce((a, b) => a + b, 0);
            html += `<td class="margin-cell"><strong>${total}</strong></td>`;
            html += '</tr>';

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderStats(containerId, dataset, algorithm) {
            const container = document.getElementById(containerId);
            const stats = calculateStats(dataset.distribution[algorithm]);
            const gini = dataset.gini[algorithm];

            container.innerHTML = `
                <div class="stat-item gini">
                    <div class="stat-label">Gini Coefficient</div>
                    <div class="stat-value">${gini.toFixed(2)}</div>
                </div>
                <div class="stat-item empty">
                    <div class="stat-label">No Representation</div>
                    <div class="stat-value">${stats.empty}</div>
                </div>
                <div class="stat-item sparse">
                    <div class="stat-label">Sparse Representation (1-2)</div>
                    <div class="stat-value">${stats.sparse}</div>
                </div>
                <div class="stat-item good">
                    <div class="stat-label">Well Represented (3+)</div>
                    <div class="stat-value">${stats.good}</div>
                </div>
            `;
        }

        function updateVisualization() {
            const selectedIndex = document.getElementById('datasetSelect').value;
            const dataset = datasets[selectedIndex];

            renderTable('leximinTable', dataset, dataset, 'leximin');
            renderTable('diversimaxTable', dataset, dataset, 'diversimax');

            renderStats('leximinStats', dataset, 'leximin');
            renderStats('diversimaxStats', dataset, 'diversimax');

            // Handle comment section
            const commentSection = document.getElementById('commentSection');
            const commentText = dataset.comment || '';

            if (commentText) {
                document.getElementById('commentText').textContent = commentText;
                commentSection.classList.add('active');
            } else {
                commentSection.classList.remove('active');
            }
        }

        function init() {
            const select = document.getElementById('datasetSelect');
            datasets.forEach((ds, i) => {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = ds.name;
                // Set Age × Gender - Kfar Saba as default (index 3)
                if (i === 3) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            select.addEventListener('change', updateVisualization);
            updateVisualization();
        }

        init();
    </script>
</body>
</html>